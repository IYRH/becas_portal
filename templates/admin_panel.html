<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del Administrador - Becas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<body class="bg-light">
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"> Panel de Becas</a>
    <div class="d-flex">
      <a href="{{ url_for('admin.logout') }}" class="btn btn-outline-light btn-sm">Cerrar sesión</a>
    </div>
  </div>
  <ul class="nav" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="solicitudes-tab" data-bs-toggle="tab" data-bs-target="#solicitudes" type="button" role="tab">📋 Solicitudes</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pagos-tab" data-bs-toggle="tab" data-bs-target="#pagos" type="button" role="tab">💰 Pagos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="convocatorias-tab" data-bs-toggle="tab" data-bs-target="#convocatorias" type="button" role="tab">📅 Convocatorias</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="requisitos-tab" data-bs-toggle="tab" data-bs-target="#requisitos" type="button" role="tab">📄 Requisitos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos" type="button" role="tab">🧾 Documentos</button>
    </li>
  </ul>
</nav>

<div class="tab-content mt-4" id="adminTabsContent">
  <!-- Sección de Solicitudes Recibidas -->
  <div class="tab-pane fade show active" id="solicitudes" role="tabpanel">

      <h2 class="mb-4 text-center"> Solicitudes Recibidas</h2>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-info text-center">{{ messages[0] }}</div>
        {% endif %}
      {% endwith %}

      {% if solicitudes %}
      <div class="table-responsive shadow">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Apellidos</th>
              <th>Matrícula</th>
              <th>Correo</th>
              <th>Teléfono</th>
              <th>Materias Reprobadas</th>
              <th>Carrera</th>
              <th>% Materias</th>
              <th>Documentos</th>
              <th>Estatus</th>
              <th>Comentarios</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for s in solicitudes %}
            <tr>
              <td>{{ s[0] }}</td>   <!-- 🔹 id -->
              <td>{{ s[1] }}</td>   <!-- 🔹 nombre -->
              <td>{{ s[2] }}</td>   <!-- 🔹 apellidos -->
              <td>{{ s[3] }}</td>   <!-- 🔹 matricula -->
              <td><a href="mailto:{{ s[4] }}">{{ s[4] }}</a></td>   <!-- 🔹 correo -->
              <td>{{ s[5] }}</td>   <!-- 🔹 telefono -->
              <td>{{ s[6] }}</td>   <!-- 🔹 nss -->
              <td>{{ s[7] }}</td>   <!-- 🔹 carrera -->
              <td>{{ s[8] }}</td>   <!-- 🔹 porcentaje_cursado -->

              <!-- PDF -->
              <td class="text-center">
                {% if s[9] %}
                  <!-- Botón para abrir el modal -->
                  <button 
                    class="btn btn-sm btn-danger d-flex align-items-center justify-content-center gap-1" 
                    data-bs-toggle="modal" 
                    data-bs-target="#pdfModal{{ s[0] }}">
                    <i class="bi bi-file-earmark-pdf-fill"></i> Ver PDF
                  </button>

                  <!-- Modal de Bootstrap (Responsive) -->
                  <div class="modal fade" id="pdfModal{{ s[0] }}" tabindex="-1" aria-labelledby="pdfModalLabel{{ s[0] }}" aria-hidden="true">
                    <div class="modal-dialog modal-fullscreen-sm-down modal-xl modal-dialog-centered">
                      <div class="modal-content border-0 shadow-lg">
                        
                        <!-- Encabezado del modal -->
                        <div class="modal-header d-flex flex-wrap justify-content-between align-items-center bg-light border-bottom">
                          <h5 class="modal-title mb-0" id="pdfModalLabel{{ s[0] }}">Vista previa del PDF</h5>
                          <div class="d-flex align-items-center gap-2 mt-2 mt-sm-0">
                            <!-- Botón Descargar -->
                            <a href="{{ url_for('static', filename='uploads/solicitudes/' + s[9]) }}" 
                              class="btn btn-success btn-sm d-flex align-items-center gap-1" 
                              download>
                              <i class="bi bi-download"></i> Descargar
                            </a>
                            <!-- Botón Cerrar -->
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
                              <i class="bi bi-x-lg"></i> Cerrar
                            </button>
                          </div>
                        </div>

                        <!-- Cuerpo del modal -->
                        <div class="modal-body p-0">
                          <div class="ratio ratio-16x9">
                            <iframe 
                              src="{{ url_for('static', filename='uploads/solicitudes/' + s[9]) }}" 
                              allowfullscreen 
                              style="border: none;">
                            </iframe>
                          </div>
                        </div>

                      </div>
                    </div>
                  </div>
                {% else %}
                  <span class="text-muted">No disponible</span>
                {% endif %}
              </td>


              <!-- Estatus -->
              <td>
                <span class="badge 
                  {% if s[10] == 'Aprobada' %}bg-success
                  {% elif s[10] == 'Rechazada' %}bg-danger
                  {% else %}bg-secondary{% endif %}">
                  {{ s[10] }}
                </span> 
              </td>

              <!-- Comentarios y acciones -->
              <td>
                <form action="{{ url_for('admin.panel') }}" method="POST" class="d-flex flex-column gap-2">
                  <input type="hidden" name="tipo" value="solicitud">
                  <input type="hidden" name="id" value="{{ s[0] }}">
                  <!-- Estatus -->
                  <select name="estatus" class="form-select form-select-sm" required>
                    <option value="En revisión" {% if s[10] == 'En revisión' %}selected{% endif %}>En revisión</option>
                    <option value="Aprobada" {% if s[10] == 'Aprobada' %}selected{% endif %}>Aprobada</option>
                    <option value="Rechazada" {% if s[10] == 'Rechazada' %}selected{% endif %}>Rechazada</option>
                  </select>   
                  <!-- Comentario -->
                  <textarea name="comentario_admin" class="form-control form-control-sm" rows="2"
                    placeholder="Escribe un comentario...">{{ s[11] or '' }}</textarea>
              </td>
              <td>          
                  <button class="btn btn-sm btn-success mt-1"> Guardar</button>
                </form>

                <form action="{{ url_for('admin.eliminar_solicitud', id=s[0]) }}" method="POST"
                  onsubmit="return confirm('¿Estás seguro de eliminar esta solicitud? Esta acción no se puede deshacer.');">
                  <button class="btn btn-sm btn-danger mt-2">Eliminar</button>
                </form>

              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <p class="text-center mt-4">No hay solicitudes registradas aún.</p>
      {% endif %}
  </div>

  <!-- Botón Descargar Excel -->
  <div class="text-end mb-3">
    <a href="{{ url_for('admin.descargar_excel') }}" class="btn btn-success">
      Descargar Excel
    </a>
  </div>

  <!-- Sección de Pagos Recibidos -->
  <div class="tab-pane fade" id="pagos" role="tabpanel">
    <h4 class="mb-3">💰 Solicitudes de Pago</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-success">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Apellidos</th>
              <th>Matrícula</th>
              <th>Archivo de pago</th>
              <th>Estatus</th>
              <th>Comentario</th>
              <th>Actualizar</th>
            </tr>
          </thead>
          <tbody>
            {% for p in pagos %}
            <tr>
              <td>{{ p[0] }}</td>
              <td>{{ p[1] }}</td>
              <td>{{ p[2] }}</td>
              <td>{{ p[3] }}</td>
              <td>
                {% if p[4] %}
                  <a href="{{ url_for('static', filename='uploads/pagos/' + p[4]) }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver Comprobante</a>
                {% else %}
                  <span class="text-muted">Sin archivo</span>
                {% endif %}
              </td>
              <td>{{ p[5] }}</td>
              <td>{{ p[6] or '' }}</td>
              <td>
                <form method="POST" action="{{ url_for('admin.panel') }}">
                  <input type="hidden" name="tipo" value="pago">
                  <input type="hidden" name="id" value="{{ p[0] }}">
                  <select name="estatus" class="form-select form-select-sm mb-2">
                    <option value="Recibida" {% if p[5]=='Recibida' %}selected{% endif %}>Recibida</option>
                    <option value="Revisada" {% if p[5]=='Revisada' %}selected{% endif %}>Revisada</option>
                    <option value="Aprobada" {% if p[5]=='Aprobada' %}selected{% endif %}>Aprobada</option>
                    <option value="Rechazada" {% if p[5]=='Rechazada' %}selected{% endif %}>Rechazada</option>
                  </select>
                  <textarea name="comentario_admin" class="form-control form-control-sm mb-2" placeholder="Comentario...">{{ p[6] or '' }}</textarea>
                  <button type="submit" class="btn btn-success btn-sm w-100">Guardar</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
  </div>

  <!-- Cambiar estado de convocatorias -->
  <div class="tab-pane fade" id="convocatorias" role="tabpanel">
    <h2 class="text-primary mb-4">Gestión de Convocatorias</h2>

    <table class="table table-bordered table-striped">
      <thead class="table-primary">
        <tr>
          <th>Convocatoria</th>
          <th>Descripción</th>
          <th>Fecha de inicio</th>
          <th>Fecha de fin</th>
          <th>Estado</th>
          <th>Actualizar</th>
        </tr>
      </thead>
      <tbody>
        {% for c in convocatorias %}
        <tr>
          <form action="{{ url_for('admin.panel') }}" method="POST">
            <input type="hidden" name="tipo" value="convocatoria">   <!-- 🔹 este es el nuevo campo -->
            <input type="hidden" name="id" value="{{ c[0] }}">
            <td>{{ c[1] }}</td>
            <td>{{ c[2] }}</td>
            <td><input type="date" class="form-control" name="fecha_inicio" value="{{ c[3] or '' }}"></td>
            <td><input type="date" class="form-control" name="fecha_fin" value="{{ c[4] or '' }}"></td>
            <td>
              {% if c[3] and c[4] %}
                {% if c[3] <= now <= c[4] %}
                  <span class="badge bg-success">Activa</span>
                {% else %}
                  <span class="badge bg-secondary">Inactiva</span>
                {% endif %}
              {% else %}
                <span class="badge bg-warning text-dark">Sin fechas</span>
              {% endif %}
            </td>
            <td><button class="btn btn-sm btn-outline-primary">Guardar</button></td>
          </form>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Sección de Requisitos -->
  <div class="tab-pane fade" id="requisitos" role="tabpanel">
    <h2 class="text-primary mb-4">Requisitos para la Beca</h2>

    <table class="table table-bordered table-striped align-middle">
      <thead class="table-primary">
        <tr>
          <th style="width: 5%;">ID</th>
          <th style="width: 70%;">Descripción</th>
          <th style="width: 25%;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r in requisitos %}
        <tr>
          <form action="{{ url_for('admin.panel') }}" method="POST">
            <input type="hidden" name="tipo" value="requisito">
            <input type="hidden" name="id" value="{{ r[0] }}">
            <td>{{ r[0] }}</td>
            <td><input type="text" class="form-control" name="contenido" value="{{ r[1] }}"></td>
            <td class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary">Guardar</button>
          </form>
          <form action="{{ url_for('admin.panel') }}" method="POST" onsubmit="return confirm('¿Seguro que deseas eliminar este requisito?');">
            <input type="hidden" name="tipo" value="eliminar_requisito">
            <input type="hidden" name="id" value="{{ r[0] }}">
            <button class="btn btn-sm btn-outline-danger">Eliminar</button>
          </form>
            </td>
        </tr>
        {% endfor %}
        <!-- Agregar nuevo requisito -->
        <tr>
          <form action="{{ url_for('admin.panel') }}" method="POST">
            <input type="hidden" name="tipo" value="requisito">
            <td>Nuevo</td>
            <td><input type="text" class="form-control" name="contenido" placeholder="Nuevo requisito..."></td>
            <td><button class="btn btn-sm btn-success">Agregar</button></td>
          </form>
        </tr>
      </tbody>
    </table>
  </div>


  <!-- Sección de Documentos Requeridos -->
  <div class="tab-pane fade" id="documentos" role="tabpanel">
    <h2 class="text-primary mb-4">Documentos Requeridos</h2>

    <table class="table table-bordered table-striped align-middle">
      <thead class="table-primary">
        <tr>
          <th style="width: 5%;">ID</th>
          <th style="width: 70%;">Descripción</th>
          <th style="width: 25%;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for d in documentos %}
        <tr>
          <form action="{{ url_for('admin.panel') }}" method="POST">
            <input type="hidden" name="tipo" value="documento">
            <input type="hidden" name="id" value="{{ d[0] }}">
            <td>{{ d[0] }}</td>
            <td><input type="text" class="form-control" name="descripcion" value="{{ d[1] }}"></td>
            <td class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary">Guardar</button>
          </form>
          <!-- Botón de eliminar -->
          <form action="{{ url_for('admin.panel') }}" method="POST" onsubmit="return confirm('¿Seguro que deseas eliminar este documento?');">
            <input type="hidden" name="tipo" value="eliminar_documento">
            <input type="hidden" name="id" value="{{ d[0] }}">
            <button class="btn btn-sm btn-outline-danger">Eliminar</button>
          </form>
            </td>
        </tr>
        {% endfor %}
        <!-- Agregar nuevo documento -->
        <tr>
          <form action="{{ url_for('admin.panel') }}" method="POST">
            <input type="hidden" name="tipo" value="documento">
            <td>Nuevo</td>
            <td><input type="text" class="form-control" name="descripcion" placeholder="Nuevo documento..."></td>
            <td><button class="btn btn-sm btn-success">Agregar</button></td>
          </form>
        </tr>
      </tbody>
    </table>
  </div>

</div>


<footer class="bg-primary text-light text-center py-3 mt-5">
  <small>© 2025 Portal de Becas - Administración</small>
</footer>

</body>
</html>

